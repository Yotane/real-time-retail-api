<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Retail Time Machine</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: #0a0a0f;
    color: #e0e0e0;
    font-family: 'Courier New', monospace;
    padding: 24px;
    min-height: 100vh;
  }
  h1 { color: #fff; font-size: 1.6em; margin-bottom: 4px; }
  .subtitle { color: #999; font-size: 0.85em; margin-bottom: 24px; }

  .dashboard {
    display: grid;
    grid-template-columns: 340px 1fr;
    gap: 20px;
    max-width: 1200px;
  }

  .panel {
    background: #12121a;
    border: 1px solid #222;
    border-radius: 8px;
    padding: 20px;
  }

  .panel h2 { font-size: 0.85em; color: #888; text-transform: uppercase;
               letter-spacing: 2px; margin-bottom: 16px; }

  /* Left panel */
  .date-display {
    font-size: 2em;
    color: #88cc88;
    font-weight: bold;
    margin-bottom: 6px;
  }
  .day-counter { color: #555; font-size: 0.8em; margin-bottom: 20px; }

  .progress-bar-wrap {
    background: #1a1a2a;
    border-radius: 4px;
    height: 8px;
    margin-bottom: 6px;
    overflow: hidden;
  }
  .progress-bar {
    height: 100%;
    background: #88cc88;
    width: 0%;
    transition: width 0.2s ease;
    border-radius: 4px;
  }
  .progress-label { color: #555; font-size: 0.75em; margin-bottom: 20px; }

  .btn-next {
    width: 100%;
    padding: 14px;
    background: #88cc88;
    color: #000;
    font-weight: bold;
    font-size: 1em;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-family: inherit;
    margin-bottom: 10px;
  }
  .btn-next:disabled { opacity: 0.3; cursor: not-allowed; }

  .btn-reset {
    width: 100%;
    padding: 8px;
    background: transparent;
    color: #555;
    border: 1px solid #333;
    border-radius: 6px;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.8em;
  }
  .btn-reset:hover { color: #ff4444; border-color: #ff4444; }

  .summary { margin-top: 20px; }
  .stat { display: flex; justify-content: space-between;
          padding: 8px 0; border-bottom: 1px solid #1a1a1a; }
  .stat-label { color: #666; font-size: 0.85em; }
  .stat-value { color: #fff; font-size: 0.85em; font-weight: bold; }
  .stat-value.green  { color: #88cc88; }
  .stat-value.blue   { color: #88aaff; }
  .stat-value.orange { color: #ffaa00; }

  /* Right panel ‚Äî event feed */
  #feed {
    height: 540px;
    overflow-y: auto;
    font-size: 0.78em;
  }
  #feed::-webkit-scrollbar { width: 4px; }
  #feed::-webkit-scrollbar-track { background: #0a0a0f; }
  #feed::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

  .event {
    padding: 5px 0;
    border-bottom: 1px solid #111;
    line-height: 1.6;
  }
  .ev-date    { color: #444; }
  .ev-store   { color: #88aaff; font-weight: bold; }
  .ev-product { color: #ff88cc; }
  .ev-units   { color: #ffff66; }
  .ev-price   { color: #88ff88; }
  .ev-promo   { color: #ff6600; font-weight: bold; }
  .ev-weather { color: #557; }
  .ev-discount{ color: #ffaa44; }

  .empty-state {
    color: #333;
    text-align: center;
    padding-top: 80px;
    font-size: 0.9em;
    line-height: 2;
  }
  .status-bar {
    margin-top: 10px;
    font-size: 0.7em;
    color: #333;
    text-align: right;
  }
  .dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%;
         background: #88cc88; margin-right: 4px;
         animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
</style>
</head>
<body>
<h1>üõí Retail Time Machine</h1>
<p class="subtitle">Step through retail history day by day ‚Äî powered by Kafka</p>
<p style="color:#664400;background:#1a1100;border:1px solid #332200;border-radius:6px;padding:10px 14px;font-size:0.78em;margin-bottom:20px;max-width:1200px;">
  ‚è≥ <strong>First startup?</strong> Historical data initialization may take up to 60 seconds. If events go over 100, then it is not yet ready. If no events appear after clicking Next Day, wait ~1 minute then click <strong>‚Ü∫ Reset</strong> followed by <strong>‚ñ∂ Next Day</strong>.
</p>

<div class="dashboard">

  <div class="panel">
    <h2>Simulation</h2>
    <div class="date-display" id="date-display">‚Äî</div>
    <div class="day-counter" id="day-counter">Click Next Day to begin</div>

    <div class="progress-bar-wrap">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
    <div class="progress-label" id="progress-label">0 / 0 events</div>

    <button class="btn-next" id="btn-next" onclick="nextDay()">‚ñ∂ Next Day</button>
    <button class="btn-reset" onclick="resetSim()">‚Ü∫ Reset</button>

    <div class="summary">
      <h2 style="margin-top:16px">Day Summary</h2>
      <div class="stat">
        <span class="stat-label">Total Revenue</span>
        <span class="stat-value green" id="s-revenue">‚Äî</span>
      </div>
      <div class="stat">
        <span class="stat-label">Units Sold</span>
        <span class="stat-value blue" id="s-units">‚Äî</span>
      </div>
      <div class="stat">
        <span class="stat-label">Transactions</span>
        <span class="stat-value" id="s-events">‚Äî</span>
      </div>
      <div class="stat">
        <span class="stat-label">Promo Events</span>
        <span class="stat-value orange" id="s-promos">‚Äî</span>
      </div>
      <div class="stat">
        <span class="stat-label">Top Product</span>
        <span class="stat-value" id="s-top">‚Äî</span>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>Live Event Feed</h2>
    <div id="feed">
      <div class="empty-state">
        No events yet.<br>
        Click <strong>‚ñ∂ Next Day</strong> to start streaming.<br><br>
        <span style="color:#664400;font-size:0.85em;">‚è≥ First startup? Wait ~60s for initialization. If events go over 100, then it is not yet ready.<br>If nothing happens, click ‚Ü∫ Reset then ‚ñ∂ Next Day.</span>
      </div>
    </div>
    <div class="status-bar" id="status-bar">waiting...</div>
  </div>

</div>

<script>
  let totalRevenue   = 0;
  let totalUnits     = 0;
  let totalEvents    = 0;
  let totalPromos    = 0;
  let topProducts    = {};
  let isRunning      = false;
  let eventSource    = null;

  function connectSSE() {
    if (eventSource) eventSource.close();
    eventSource = new EventSource('/stream/events');

    eventSource.onmessage = function(e) {
      const event = JSON.parse(e.data);
      appendEvent(event);
      updateSummary(event);
      updateProgress(event);
    };

    eventSource.onerror = function() {
      document.getElementById('status-bar').textContent = 'reconnecting...';
    };
  }

  let currentDay = null;

  function appendEvent(event) {
    if (currentDay && event.date !== currentDay) return;
    
    const feed = document.getElementById('feed');
    const empty = feed.querySelector('.empty-state');
    if (empty) empty.remove();

    const div   = document.createElement('div');
    div.className = 'event';

    const promo    = event.is_holiday_promo ? ' üè∑Ô∏è PROMO' : '';
    const discount = event.discount > 0 ? `(-${event.discount}%)` : '';
    const weather  = event.weather ? `[${event.weather}]` : '';

    div.textContent =
      `${event.date} ${event.store_id} ‚Üí ${event.product_id} | ${event.units_sold} units @ $${event.price} ${discount} ${weather}${promo}`;

    feed.insertBefore(div, feed.firstChild);
    while (feed.children.length > 300) feed.removeChild(feed.lastChild);

    document.getElementById('status-bar').textContent = 'streaming live';
  }

  function updateSummary(event) {
    totalEvents++;
    totalUnits   += event.units_sold || 0;
    totalRevenue += (event.units_sold || 0) * (event.price || 0);
    if (event.is_holiday_promo) totalPromos++;

    const pid = event.product_id;
    topProducts[pid] = (topProducts[pid] || 0) + (event.units_sold || 0);

    document.getElementById('s-revenue').textContent =
      '$' + totalRevenue.toFixed(2);
    document.getElementById('s-units').textContent = totalUnits;
    document.getElementById('s-events').textContent = totalEvents;
    document.getElementById('s-promos').textContent = totalPromos;

    const topPid = Object.entries(topProducts).sort((a,b)=>b[1]-a[1])[0];
    document.getElementById('s-top').textContent =
      topPid ? `${topPid[0]} (${topPid[1]})` : '‚Äî';
  }

  function updateProgress(event) {
    const total = event.day_total || 0;
    if (!total) return;
    const pct = Math.min((totalEvents / total) * 100, 100);
    document.getElementById('progress-bar').style.width = pct + '%';
    document.getElementById('progress-label').textContent = `${totalEvents} / ${total} events`;
    if (totalEvents >= total) {
        document.getElementById('btn-next').disabled = false;
        document.getElementById('status-bar').textContent = '‚úì Day complete ‚Äî click Next Day';
    }
}

  async function nextDay() {
    document.getElementById('btn-next').disabled = true;
    isRunning = true;
    totalRevenue = 0; totalUnits = 0; totalEvents = 0; totalPromos = 0; topProducts = {};
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-label').textContent = 'loading...';

    const resp = await fetch('/simulation/next-day', { method: 'POST' });
    const data = await resp.json();
    currentDay = data.current_day;
    document.getElementById('date-display').textContent = data.current_day;
    const status = await fetch('/simulation/status').then(r => r.json());
    document.getElementById('day-counter').textContent = `Day ${status.day_index + 1} of ${status.total_days}`;
  }

  async function resetSim() {
    await fetch('/simulation/reset', { method: 'POST' });
    document.getElementById('date-display').textContent = '‚Äî';
    document.getElementById('day-counter').textContent = 'Click Next Day to begin';
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-label').textContent = '0 / 0 events';
    document.getElementById('feed').innerHTML = '<div class="empty-state">Reset. Click ‚ñ∂ Next Day to start again.</div>';
    ['s-revenue','s-units','s-events','s-promos','s-top'].forEach(id=>document.getElementById(id).textContent='‚Äî');
    document.getElementById('btn-next').disabled = false;
  }

  connectSSE();
</script>
</body>
</html>